- name: Run multiple instances in single job
  run: |
    # استراتيجية ذكية للتشغيل المتوازي
    echo "=== Starting Smart Parallel Execution ==="
    
    # عدد العمليات الإجمالي المطلوب
    TOTAL_INSTANCES=100
    
    # إنشاء قائمة بجميع instance IDs
    seq 1 $TOTAL_INSTANCES > instances.txt
    
    # الطريقة 1: استخدام GNU Parallel بدون --progress
    echo "Method 1: Using GNU Parallel with controlled concurrency"
    
    # التعديل هنا: أزل --progress
    parallel -j 10 --delay 0.2 \
      'INSTANCE_ID={} php -d memory_limit=512M -d max_execution_time=300 main.php 2>&1 | tail -5' \
      :::: instances.txt
    
    # أو الطريقة 2: استخدام clusters من العمليات
    echo -e "\n=== Alternative Method: Process Clusters ==="
    
    # تقسيم إلى 5 مجموعات من 20 عملية
    for CLUSTER in {1..5}; do
      echo "Starting Cluster $CLUSTER (Instances $((($CLUSTER-1)*20+1))-$((CLUSTER*20)))"
      
      # تشغيل 20 عملية في الخلفية
      for i in $(seq $((($CLUSTER-1)*20+1)) $((CLUSTER*20))); do
        INSTANCE_ID=$i php -d memory_limit=256M main.php >/dev/null 2>&1 &
        # تأخير قصير بين كل عملية
        sleep 0.05
      done
      
      # انتظار انتهاء المجموعة الحالية قبل البدء بالتي تليها
      echo "Waiting for cluster $CLUSTER to complete..."
      wait
      
      # استراحة قصيرة بين المجموعات
      sleep 2
    done
    
    echo "All instances completed!"
