name: PR Test Optimized
on:
  schedule:
    - cron: '*/3 * * * *'
  workflow_dispatch:
jobs:
  high-speed-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: curl, simplexml, pcntl, posix
      - name: Install parallel utility
        run: |
          sudo apt-get update
          sudo apt-get install -y parallel
      - name: Prepare system environment
        run: |
          ulimit -n 10240
          ulimit -u 10240
      - name: Run all instances
        run: |
          echo "=== Starting 100 Instances ==="
          seq 1 100 > instances.txt
          cat > run_instance.sh << 'EOF'
          #!/bin/bash
          INSTANCE_ID=$1
          echo "Starting instance $INSTANCE_ID"
          php -d memory_limit=2G -d max_execution_time=600 -d opcache.enable=1 main.php > instance_${INSTANCE_ID}.log 2>&1 &
          echo $! > pid_${INSTANCE_ID}
          EOF
          chmod +x run_instance.sh
          parallel -j 20 --delay 0.5 --joblog /tmp/parallel.log ./run_instance.sh :::: instances.txt
          sleep 5
          echo "All instances started, monitoring..."
          for i in {1..20}; do
            RUNNING=$(ps aux | grep -c "[p]hp main.php")
            echo "Active instances: $RUNNING/100"
            if [ $RUNNING -eq 0 ]; then
              break
            fi
            sleep 5
          done
          echo "=== Finalizing ==="
          for i in {1..100}; do
            if [ -f "pid_$i" ]; then
              kill -9 $(cat "pid_$i") 2>/dev/null || true
              rm -f "pid_$i"
            fi
          done
          wait
          echo "=== Execution Completed ==="
      - name: Collect results
        if: always()
        run: |
          echo "=== Results Summary ==="
          TOTAL_LOGS=$(ls -la instance_*.log 2>/dev/null | wc -l)
          echo "Log files generated: $TOTAL_LOGS"
          echo "=== Sample Output (last 3 instances) ==="
          for i in {98..100}; do
            if [ -f "instance_$i.log" ]; then
              echo "--- Instance $i ---"
              tail -5 "instance_$i.log"
            fi
          done
      - name: Cleanup
        run: |
          rm -f instances.txt run_instance.sh instance_*.log pid_* 2>/dev/null || true
